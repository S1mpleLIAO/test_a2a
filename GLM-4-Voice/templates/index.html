<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>GLM-4-Voice Streaming Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="/static/style.css" rel="stylesheet" />
</head>
<body>
  <div class="app-shell">
    <!-- 左侧侧边栏 -->
    <aside class="sidebar">
      <div class="sidebar-top">
        <div class="brand">
          <span class="brand-dot"></span>
          <span class="brand-text">项目</span>
        </div>
        <button class="new-chat-btn" id="new_chat_btn">新聊天</button>
      </div>


      <!-- 新增：会话列表 -->
      <nav class="sidebar-section">
        <div class="section-title">会话</div>
        <ul class="nav-list sessions" id="session_list">
          <!-- 动态渲染 -->
        </ul>
      </nav>
    </aside>

    <!-- 主内容 -->
    <main class="main">
      <header class="hero">
        <div class="hero-title">有什么可以帮忙的？</div>
        <div class="hero-sub">GLM-4-Voice · FastAPI · 流式对话</div>
      </header>

      <section class="input-bar-card">
        <form id="chat-form" class="input-bar">
          <div class="segmented">
            <input type="radio" id="mode_audio" name="mode_seg" checked>
            <label for="mode_audio" class="seg-btn" data-mode="audio">语音</label>
            <input type="radio" id="mode_text" name="mode_seg">
            <label for="mode_text" class="seg-btn" data-mode="text">文本</label>
            <select id="input_mode" name="input_mode" class="hidden">
              <option value="audio" selected>audio</option>
              <option value="text">text</option>
            </select>
          </div>

          <div class="bar-middle">
            <textarea id="text_input" rows="1" placeholder="（可选）先输入补充文本，或直接点击左侧麦克风开始录音…" class="bar-textarea"></textarea>
          </div>

          <div class="bar-actions">
            <button type="button" id="rec_btn" class="icon-btn" title="开始/停止录音">
              <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
                <path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 0 0-6 0v5a3 3 0 0 0 3 3Zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 14 0h-2Zm-5 7a7 7 0 0 0 7-7h-2a5 5 0 1 1-10 0H5a7 7 0 0 0 7 7Zm-1 2h2v2h-2v-2Z" fill="currentColor"/>
              </svg>
            </button>
            <button type="submit" id="submit_btn" class="primary-btn" title="发送">发送</button>
          </div>

          <span id="rec_status" class="rec-status muted"></span>

          <details class="adv">
            <summary>高级参数</summary>
            <div class="adv-grid">
              <label>Temperature <input id="temperature" type="number" step="0.01" value="0.2" /></label>
              <label>Top-p <input id="top_p" type="number" step="0.01" value="0.8" /></label>
              <label>Max new tokens <input id="max_new_tokens" type="number" value="2000" /></label>
            </div>
          </details>

          <!-- 会话上下文（每个会话独立保存） -->
          <input id="prev_input_tokens" type="hidden" value="">
          <input id="prev_completion_tokens" type="hidden" value="">
        </form>
      </section>

      <section class="chat-wrapper">
        <div class="chat-toolbar">
          <button type="button" id="clear_btn" class="ghost-btn">清除</button>
        </div>

        <div id="chat-area" class="chat-area"></div>

        <div class="player">
          <div class="player-title">Assistant (streaming audio)</div>
          <div class="player-controls">
            <button type="button" id="pause_btn" class="ghost-btn" disabled>暂停</button>
            <span id="audio_status" class="muted">未播放</span>
          </div>
        </div>

        <p class="muted foot-note">* 录音采用 MediaRecorder；提交后通过 WebSocket 边解码边播放。可点击“暂停/继续”。</p>
      </section>
    </main>
  </div>

  <!-- ====== 功能脚本（新增：本地会话管理） ====== -->
  <script>
    /********** 会话存储辅助 **********/
    const LS_KEY = 'glm_voice_sessions';
    const LS_CUR = 'glm_voice_current';

    function loadAllSessions() {
      try { return JSON.parse(localStorage.getItem(LS_KEY) || '{}'); }
      catch { return {}; }
    }
    function saveAllSessions(obj) { localStorage.setItem(LS_KEY, JSON.stringify(obj)); }
    function getCurrentId() { return localStorage.getItem(LS_CUR) || null; }
    function setCurrentId(id) { if (id) localStorage.setItem(LS_CUR, id); else localStorage.removeItem(LS_CUR); }

    function createSession() {
      const id = String(Date.now());
      const all = loadAllSessions();
      all[id] = {
        id, title: '新会话', created: Date.now(),
        history: [], prev_input: '', prev_completion: ''
      };
      saveAllSessions(all);
      setCurrentId(id);
      return id;
    }
    function deleteSession(id) {
      const all = loadAllSessions();
      delete all[id];
      saveAllSessions(all);
      if (getCurrentId() === id) {
        const rest = Object.keys(all);
        setCurrentId(rest[0] || '');
      }
    }
    function getSession(id) { return loadAllSessions()[id] || null; }
    function updateSession(id, patch) {
      const all = loadAllSessions();
      if (!all[id]) return;
      all[id] = { ...all[id], ...patch };
      saveAllSessions(all);
    }

    /********** 侧栏会话列表渲染 **********/
    const sessionListEl = document.getElementById('session_list');
    function renderSessionList() {
      const all = loadAllSessions();
      const cur = getCurrentId();
      const ids = Object.keys(all).sort((a,b)=>all[b].created-all[a].created);
      sessionListEl.innerHTML = '';
      if (!ids.length) return;
      ids.forEach(id => {
        const s = all[id];
        const li = document.createElement('li');
        li.className = 'session-item' + (id===cur ? ' active' : '');
        li.innerHTML = `
          <button class="session-btn" data-id="${id}" title="${s.title || '会话'}">
            <span class="session-title">${(s.title || '会话')}</span>
          </button>
          <button class="session-del" data-id="${id}" title="删除">×</button>
        `;
        sessionListEl.appendChild(li);
      });
    }

    sessionListEl.addEventListener('click', (e) => {
      const del = e.target.closest('.session-del');
      const btn = e.target.closest('.session-btn');
      if (del) {
        const id = del.dataset.id;
        const isCur = id === getCurrentId();
        deleteSession(id);
        renderSessionList();
        if (isCur) { loadCurrentToUI(); }
        return;
      }
      if (btn) {
        const id = btn.dataset.id;
        setCurrentId(id);
        renderSessionList();
        loadCurrentToUI();
      }
    });

    /********** 绑定“新聊天” **********/
    document.getElementById('new_chat_btn').addEventListener('click', () => {
      const id = createSession();
      renderSessionList();
      resetUI();
      loadCurrentToUI(); // 空白新会话
    });

    /********** 现有页面逻辑（保持你原有的 ID 和行为） **********/
    const segBtns = document.querySelectorAll('.seg-btn');
    const inputModeSel = document.getElementById('input_mode');
    const textRow = document.getElementById('text_row');
    const recordRow = document.getElementById('record_row');
    segBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const mode = btn.dataset.mode;
        inputModeSel.value = mode;
        document.getElementById('mode_audio').checked = (mode === 'audio');
        document.getElementById('mode_text').checked = (mode === 'text');
        document.querySelector('.bar-textarea')
          .setAttribute('placeholder', mode==='text' ? '输入你想问的问题…' : '（可选）先输入补充文本，或直接点击左侧麦克风开始录音…');
      });
    });

    const form = document.getElementById("chat-form");
    const recBtn = document.getElementById("rec_btn");
    const recStatus = document.getElementById("rec_status");
    const pauseBtn = document.getElementById("pause_btn");
    const audioStatus = document.getElementById("audio_status");
    const clearBtn = document.getElementById("clear_btn");
    const textInput = document.getElementById("text_input");
    const chatArea = document.getElementById("chat-area");
    const prevInputTokensEl = document.getElementById("prev_input_tokens");
    const prevCompletionTokensEl = document.getElementById("prev_completion_tokens");

    function appendMsg(role, content) {
      const wrap = document.createElement("div");
      wrap.className = "msg " + (role === "user" ? "user" : (role==='system'?'bot':'bot'));
      const safe = String(content ?? "").replace(/[&<>]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[s]));
      wrap.innerHTML = `<div class="role">${role}</div><div class="bubble">${safe || "（空）"}</div>`;
      chatArea.appendChild(wrap);
      chatArea.scrollTop = chatArea.scrollHeight;
    }
    function setLoading(role) {
      const wrap = document.createElement("div");
      wrap.className = "msg bot";
      wrap.id = "loading-msg";
      wrap.innerHTML = `<div class="role">${role}</div><div class="bubble">推理中…</div>`;
      chatArea.appendChild(wrap);
      chatArea.scrollTop = chatArea.scrollHeight;
    }
    function clearLoading(){ const node=document.getElementById("loading-msg"); if(node) node.remove(); }

    // 录音
    let mediaRecorder=null, recordedChunks=[], recording=false;
    async function initMedia(){
      if (mediaRecorder) return;
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream,{ mimeType:'audio/webm' });
      mediaRecorder.ondataavailable = (e)=>{ if(e.data&&e.data.size>0) recordedChunks.push(e.data); };
      mediaRecorder.onstart = ()=>{ recordedChunks = []; recStatus.textContent="录音中… 再次点击停止"; recBtn.classList.add('rec-on'); };
      mediaRecorder.onstop  = ()=>{ recStatus.textContent="录音已停止"; recBtn.classList.remove('rec-on'); };
    }
    recBtn.addEventListener("click", async ()=>{
      const mode = inputModeSel.value;
      if (mode !== 'audio') { inputModeSel.value = 'audio'; document.getElementById('mode_audio').checked = true; }
      await initMedia();
      if (!mediaRecorder) { alert("无法初始化麦克风"); return; }
      if (!recording) { mediaRecorder.start(); recording=true; recBtn.title="停止录音"; }
      else { mediaRecorder.stop(); recording=false; recBtn.title="开始录音"; }
    });

    // WebAudio 串行播放
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let audioPlayHead = 0;
    async function enqueueWavBase64(b64){
      if (audioCtx.state === "suspended") { try{ await audioCtx.resume(); }catch{} }
      pauseBtn.disabled=false; pauseBtn.textContent="暂停";
      const bytes = Uint8Array.from(atob(b64), c=>c.charCodeAt(0));
      const audioBuffer = await audioCtx.decodeAudioData(bytes.buffer);
      const src = audioCtx.createBufferSource();
      src.buffer = audioBuffer; src.connect(audioCtx.destination);
      const now = audioCtx.currentTime;
      const startAt = Math.max(now + 0.05, audioPlayHead || now + 0.05);
      src.start(startAt);
      audioPlayHead = startAt + audioBuffer.duration;
      audioStatus.textContent = "播放中…";
    }
    async function ensureRunning(){ if (audioCtx.state === "suspended") { try{ await audioCtx.resume(); }catch{} } }
    function resetAudioQueue(){ audioPlayHead = audioCtx.currentTime; audioStatus.textContent="未播放"; pauseBtn.textContent="暂停"; pauseBtn.disabled=true; }
    pauseBtn.addEventListener("click", async ()=>{
      try{
        if (audioCtx.state === "running") { await audioCtx.suspend(); pauseBtn.textContent="继续"; audioStatus.textContent="已暂停"; }
        else { await audioCtx.resume(); pauseBtn.textContent="暂停"; audioStatus.textContent="播放中…"; }
      }catch(e){ console.error(e); }
    });

    // WebSocket 流式提交（与后端对接保持不变）
    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const mode = inputModeSel.value;
      const temperature = Number(document.getElementById("temperature").value || 0.2);
      const top_p       = Number(document.getElementById("top_p").value || 0.8);
      const max_new_tokens = Number(document.getElementById("max_new_tokens").value || 2000);
      const prev_input  = prevInputTokensEl.value || "";
      const prev_completion = prevCompletionTokensEl.value || "";
      let userToast=""; let audioBlob=null;

      if (mode === "audio") {
        if (recording) { alert("请先停止录音"); return; }
        if (!recordedChunks.length) { alert("请先开始录音并停止后再提交"); return; }
        userToast="(用户语音)";
        audioBlob = new Blob(recordedChunks, { type:'audio/webm' });
      } else {
        const t = (textInput.value || "").trim();
        if (!t) { alert("请输入文本"); return; }
        userToast = t;
      }

      appendMsg("user", userToast);
      setLoading("assistant");
      resetAudioQueue(); await ensureRunning();

      const ws = new WebSocket((location.protocol === "https:" ? "wss://" : "ws://") + location.host + "/ws");

      ws.onopen = async ()=>{
        const init = {
          action:"start", mode, temperature, top_p, max_new_tokens,
          previous_input_tokens: prev_input,
          previous_completion_tokens: prev_completion,
          text: (mode==="text") ? (textInput.value || "") : undefined
        };
        ws.send(JSON.stringify(init));
        if (mode==="audio" && audioBlob) {
          const buf = await audioBlob.arrayBuffer();
          ws.send(buf);
        }
      };

      let textBuf = "";
      ws.onmessage = async (ev)=>{
        try{
          const msg = JSON.parse(ev.data);
          if (msg.type === "error") {
            clearLoading(); appendMsg("assistant", "错误：" + msg.message); ws.close(); return;
          }
          if (msg.type === "text_delta") {
            textBuf += msg.delta || "";
            const loading = document.getElementById("loading-msg");
            if (loading) loading.querySelector(".bubble").textContent = textBuf;
          }
          if (msg.type === "audio_chunk") { await enqueueWavBase64(msg.wav_b64); }
          if (msg.type === "done") {
            clearLoading(); appendMsg("assistant", textBuf || "（无文本输出）");
            if (typeof msg.input_tokens === "string") prevInputTokensEl.value = msg.input_tokens;
            if (typeof msg.completion_tokens === "string") prevCompletionTokensEl.value = msg.completion_tokens;

            // —— 保存到当前会话 —— //
            const curId = getCurrentId() || createSession();
            const title = (userToast && userToast !== "(用户语音)")
              ? userToast.slice(0, 18)
              : (textBuf || '新会话');
            const cur = getSession(curId) || { id: curId, history: [] };
            cur.history.push({ role:'user', content:userToast });
            cur.history.push({ role:'assistant', content:textBuf });
            updateSession(curId, {
              title, history: cur.history,
              prev_input: prevInputTokensEl.value,
              prev_completion: prevCompletionTokensEl.value
            });
            renderSessionList();
            ws.close();
          }
        }catch(_){}
      };

      ws.onerror = ()=>{ clearLoading(); appendMsg("assistant", "WebSocket 出错"); };
    });

    // 清除：只清屏，不删除会话（会话上下文也清空）
    clearBtn.addEventListener("click", async ()=>{
      chatArea.innerHTML = "";
      form.reset();
      document.getElementById('mode_audio').checked = true;
      inputModeSel.value = 'audio';
      prevInputTokensEl.value = "";
      prevCompletionTokensEl.value = "";
      recordedChunks = [];
      resetAudioQueue();
      try { await fetch("/api/clear", { method:"POST" }); } catch {}
      appendMsg("system", "对话已清空。");

      const curId = getCurrentId();
      if (curId) updateSession(curId, {
        history: [],
        prev_input: "", prev_completion: ""
      });
    });

    /********** 将当前会话内容加载到 UI **********/
    function resetUI() {
      chatArea.innerHTML = "";
      form.reset();
      inputModeSel.value = 'audio';
      document.getElementById('mode_audio').checked = true;
      prevInputTokensEl.value = "";
      prevCompletionTokensEl.value = "";
      recordedChunks = [];
      resetAudioQueue();
    }
    function loadCurrentToUI() {
      resetUI();
      const curId = getCurrentId();
      if (!curId) return;
      const s = getSession(curId);
      if (!s) return;
      // 历史消息渲染
      (s.history || []).forEach(m => appendMsg(m.role, m.content));
      // 恢复上下文
      prevInputTokensEl.value = s.prev_input || "";
      prevCompletionTokensEl.value = s.prev_completion || "";
      renderSessionList();
    }

    // 初始化：若没有会话，先建一个
    (function init() {
      const all = loadAllSessions();
      if (!Object.keys(all).length) {
        const id = createSession();
        setCurrentId(id);
      } else if (!getCurrentId()) {
        setCurrentId(Object.keys(all)[0]);
      }
      renderSessionList();
      loadCurrentToUI();
    })();
  </script>
</body>
</html>
